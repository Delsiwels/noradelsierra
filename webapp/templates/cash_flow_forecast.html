{% extends "base.html" %}

{% block title %}Cash Flow Forecast - BAS Reviewer{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Cash Flow Forecast</h1>
                <p class="mt-1 text-gray-500">12-month projection with compliance calendar</p>
            </div>
            <div class="mt-4 md:mt-0 flex items-center space-x-4">
                <!-- Lodge Method Toggle -->
                <div class="inline-flex rounded-md bg-gray-100 p-0.5" id="lodgeToggle">
                    <button type="button" onclick="setLodgeMethod('self')"
                            id="btn-self"
                            class="px-3 py-1.5 text-xs font-medium rounded transition-colors focus:outline-none">
                        Self Lodge
                    </button>
                    <button type="button" onclick="setLodgeMethod('agent')"
                            id="btn-agent"
                            class="px-3 py-1.5 text-xs font-medium rounded transition-colors focus:outline-none">
                        Tax Agent
                    </button>
                </div>
                <!-- Generate Button -->
                <button onclick="generateForecast()" id="generateBtn"
                        class="bg-primary hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-sm font-medium transition-colors">
                    Generate Forecast
                </button>
            </div>
        </div>
    </div>
</section>

<!-- Xero Not Connected Banner (hidden by default) -->
<div id="xeroNotConnected" class="hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
            <svg class="mx-auto h-16 w-16 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                      d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
            </svg>
            <h2 class="text-xl font-semibold text-gray-900 mb-2">Connect your Xero account to generate a cash flow forecast</h2>
            <p class="text-gray-500 mb-6">We'll pull your bank balances and recent transactions to build a 12-month projection.</p>
            <a href="/connections/xero/connect"
               class="inline-flex items-center bg-primary hover:bg-blue-700 text-white px-6 py-3 rounded-lg text-sm font-medium transition-colors">
                Connect to Xero
            </a>
        </div>
    </div>
</div>

<!-- Forecast Content (hidden until generated) -->
<div id="forecastContent" class="hidden">

    <!-- Summary Cards -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                <p class="text-sm font-medium text-gray-500">Current Cash</p>
                <p class="text-2xl font-bold text-gray-900 mt-1" id="cardCurrentCash">--</p>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                <p class="text-sm font-medium text-gray-500">Cash Runway</p>
                <p class="text-2xl font-bold text-gray-900 mt-1" id="cardCashRunway">--</p>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                <p class="text-sm font-medium text-gray-500">Lowest Balance</p>
                <p class="text-2xl font-bold text-gray-900 mt-1" id="cardLowestBalance">--</p>
                <p class="text-xs text-gray-400 mt-1" id="cardLowestMonth"></p>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-sm border border-primary/30">
                <p class="text-sm font-medium text-primary">BAS Payments Due</p>
                <p class="text-2xl font-bold text-primary mt-1" id="cardBasPayments">--</p>
                <p class="text-xs text-gray-400 mt-1">in next 12 months</p>
            </div>
        </div>
    </section>

    <!-- Risk Alerts -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" id="riskAlerts">
    </section>

    <!-- Bank Account Breakdown -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <button onclick="toggleAccounts()" class="w-full flex items-center justify-between p-4 text-left">
                <span class="text-sm font-semibold text-gray-900">Bank Account Breakdown</span>
                <svg id="accountsChevron" class="h-5 w-5 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>
            <div id="accountsList" class="hidden border-t border-gray-100 px-4 pb-4">
            </div>
        </div>
    </section>

    <!-- Forecast Table -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="p-4 border-b border-gray-200">
                <h2 class="text-sm font-semibold text-gray-900">12-Month Forecast</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Month</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Inflows</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Outflows</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">BAS Payment</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Net</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th>
                        </tr>
                    </thead>
                    <tbody id="forecastTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Compliance Calendar -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 pb-12">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-sm font-semibold text-gray-900">Compliance Calendar</h2>
                <span class="text-xs text-gray-400" id="calendarLabel">Showing deadlines for: Self-lodger</span>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="calendarCards">
            </div>
        </div>
    </section>

</div>

<!-- Empty State (before first generation) -->
<div id="emptyState">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
            <svg class="mx-auto h-16 w-16 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                      d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            <h2 class="text-xl font-semibold text-gray-900 mb-2">Generate your cash flow forecast</h2>
            <p class="text-gray-500 mb-6">Click "Generate Forecast" to create a 12-month projection based on your Xero data.</p>
        </div>
    </div>

    <!-- Compliance Calendar (always visible) -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 pb-12">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-sm font-semibold text-gray-900">Compliance Calendar</h2>
                <span class="text-xs text-gray-400" id="calendarLabelEmpty">Showing deadlines for: Self-lodger</span>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="calendarCardsEmpty">
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentLodgeMethod = '{{ lodge_method }}';
let forecastData = null;

// Initialise lodge toggle state
document.addEventListener('DOMContentLoaded', function() {
    updateToggleUI();
    loadDeadlines();
});

function updateToggleUI() {
    const btnSelf = document.getElementById('btn-self');
    const btnAgent = document.getElementById('btn-agent');
    if (currentLodgeMethod === 'agent') {
        btnAgent.className = 'px-3 py-1.5 text-xs font-medium rounded bg-white shadow text-gray-900 transition-colors focus:outline-none';
        btnSelf.className = 'px-3 py-1.5 text-xs font-medium rounded text-gray-500 hover:text-gray-700 transition-colors focus:outline-none';
    } else {
        btnSelf.className = 'px-3 py-1.5 text-xs font-medium rounded bg-white shadow text-gray-900 transition-colors focus:outline-none';
        btnAgent.className = 'px-3 py-1.5 text-xs font-medium rounded text-gray-500 hover:text-gray-700 transition-colors focus:outline-none';
    }
}

async function setLodgeMethod(method) {
    if (method === currentLodgeMethod) return;
    currentLodgeMethod = method;
    updateToggleUI();

    // Persist preference
    try {
        await fetch('/api/forecast/lodge-method', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({lodge_method: method}),
        });
    } catch(e) { /* ignore persistence errors */ }

    // Refresh deadlines
    loadDeadlines();
}

async function loadDeadlines() {
    try {
        const resp = await fetch(`/api/forecast/deadlines?lodge_method=${currentLodgeMethod}`);
        const data = await resp.json();
        renderDeadlineCards(data.deadlines, 'calendarCards', 'calendarLabel');
        renderDeadlineCards(data.deadlines, 'calendarCardsEmpty', 'calendarLabelEmpty');
    } catch(e) {
        console.error('Failed to load deadlines', e);
    }
}

function renderDeadlineCards(deadlines, containerId, labelId) {
    const container = document.getElementById(containerId);
    const label = document.getElementById(labelId);
    if (!container) return;

    if (label) {
        label.textContent = 'Showing deadlines for: ' + (currentLodgeMethod === 'agent' ? 'Tax agent' : 'Self-lodger');
    }

    container.innerHTML = '';
    deadlines.forEach(function(dl) {
        const statusColor = dl.status === 'due_soon' ? 'border-yellow-400 bg-yellow-50'
            : dl.status === 'overdue' ? 'border-red-400 bg-red-50'
            : dl.status === 'upcoming' ? 'border-blue-400 bg-blue-50'
            : 'border-gray-200 bg-gray-50';

        const daysText = dl.days_remaining < 0
            ? Math.abs(dl.days_remaining) + ' days overdue'
            : dl.days_remaining + ' days';

        const card = document.createElement('div');
        card.className = `rounded-lg border-2 ${statusColor} p-4 text-center`;
        card.innerHTML = `
            <p class="text-xs font-medium text-gray-500 mb-1">${dl.quarter}</p>
            <p class="text-sm font-semibold text-gray-900">${dl.due_date}</p>
            <p class="text-xs text-gray-500 mt-1">${daysText}</p>
        `;
        container.appendChild(card);
    });
}

function formatCurrency(amount) {
    const abs = Math.abs(amount);
    const formatted = abs.toLocaleString('en-AU', {minimumFractionDigits: 0, maximumFractionDigits: 0});
    return amount < 0 ? '-$' + formatted : '$' + formatted;
}

function formatCurrencyDetailed(amount) {
    const abs = Math.abs(amount);
    const formatted = abs.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    return amount < 0 ? '-$' + formatted : '$' + formatted;
}

async function generateForecast() {
    const btn = document.getElementById('generateBtn');
    btn.disabled = true;
    btn.textContent = 'Generating...';

    try {
        const resp = await fetch('/api/forecast/generate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({lodge_method: currentLodgeMethod}),
        });

        const data = await resp.json();

        if (!resp.ok) {
            if (resp.status === 400 && data.error === 'Xero not connected') {
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('forecastContent').classList.add('hidden');
                document.getElementById('xeroNotConnected').classList.remove('hidden');
                return;
            }
            alert(data.error || 'Failed to generate forecast');
            return;
        }

        forecastData = data;
        renderForecast(data);
    } catch(e) {
        alert('Network error. Please try again.');
        console.error(e);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Generate Forecast';
    }
}

function renderForecast(data) {
    // Show forecast content, hide empty state
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('xeroNotConnected').classList.add('hidden');
    document.getElementById('forecastContent').classList.remove('hidden');

    // Summary cards
    document.getElementById('cardCurrentCash').textContent = formatCurrency(data.summary.current_cash);
    if (data.summary.current_cash < 0) {
        document.getElementById('cardCurrentCash').className = 'text-2xl font-bold text-red-600 mt-1';
    }

    document.getElementById('cardCashRunway').textContent =
        data.summary.cash_runway !== null ? data.summary.cash_runway + ' months' : 'N/A (positive)';

    document.getElementById('cardLowestBalance').textContent = formatCurrency(data.summary.lowest_balance);
    document.getElementById('cardLowestMonth').textContent = data.summary.lowest_balance_month;
    if (data.summary.lowest_balance < 0) {
        document.getElementById('cardLowestBalance').className = 'text-2xl font-bold text-red-600 mt-1';
    }

    document.getElementById('cardBasPayments').textContent =
        data.summary.bas_payments_due + ' in next 12mo';

    // Risk alerts
    const alertsContainer = document.getElementById('riskAlerts');
    alertsContainer.innerHTML = '';
    data.risk_indicators.forEach(function(ri) {
        const colorMap = {
            red: 'bg-red-50 border-red-200 text-red-700',
            yellow: 'bg-yellow-50 border-yellow-200 text-yellow-700',
            blue: 'bg-blue-50 border-blue-200 text-blue-700',
        };
        const cls = colorMap[ri.level] || colorMap.blue;
        const div = document.createElement('div');
        div.className = `rounded-lg border p-3 mb-2 text-sm ${cls}`;
        div.textContent = ri.message;
        alertsContainer.appendChild(div);
    });

    // Bank accounts
    const accountsList = document.getElementById('accountsList');
    accountsList.innerHTML = '';
    data.accounts.forEach(function(acct) {
        const row = document.createElement('div');
        row.className = 'flex justify-between items-center py-2';
        row.innerHTML = `
            <span class="text-sm text-gray-700">${acct.name}</span>
            <span class="text-sm font-medium ${acct.balance < 0 ? 'text-red-600' : 'text-gray-900'}">${formatCurrencyDetailed(acct.balance)}</span>
        `;
        accountsList.appendChild(row);
    });

    // Forecast table
    const tbody = document.getElementById('forecastTableBody');
    tbody.innerHTML = '';
    data.months.forEach(function(m) {
        const tr = document.createElement('tr');
        const hasBas = m.bas_payment < 0;
        if (hasBas) {
            tr.className = 'border-l-4 border-l-yellow-400';
        }
        tr.innerHTML = `
            <td class="px-4 py-3 text-sm font-medium text-gray-900">${m.month}</td>
            <td class="px-4 py-3 text-sm text-right text-green-600">${formatCurrencyDetailed(m.inflows)}</td>
            <td class="px-4 py-3 text-sm text-right text-red-600">${formatCurrencyDetailed(m.outflows)}</td>
            <td class="px-4 py-3 text-sm text-right ${hasBas ? 'text-yellow-700 font-medium' : 'text-gray-400'}">
                ${hasBas ? formatCurrencyDetailed(m.bas_payment) + ' ' + (m.bas_info ? m.bas_info.quarter : '') : ''}
            </td>
            <td class="px-4 py-3 text-sm text-right ${m.net >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrencyDetailed(m.net)}</td>
            <td class="px-4 py-3 text-sm text-right font-medium ${m.balance < 0 ? 'text-red-600' : 'text-gray-900'}">${formatCurrencyDetailed(m.balance)}</td>
        `;
        tbody.appendChild(tr);
    });

    // Compliance calendar
    if (data.deadlines) {
        renderDeadlineCards(data.deadlines, 'calendarCards', 'calendarLabel');
    }
}

function toggleAccounts() {
    const list = document.getElementById('accountsList');
    const chevron = document.getElementById('accountsChevron');
    list.classList.toggle('hidden');
    chevron.classList.toggle('rotate-180');
}
</script>
{% endblock %}
