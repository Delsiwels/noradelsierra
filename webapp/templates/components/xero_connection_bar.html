{% if current_user and current_user.is_authenticated %}
<style>
    .xero-connection-banner {
        position: sticky;
        top: 0;
        z-index: 40;
        background: linear-gradient(135deg, #13B5EA 0%, #0E8FC2 100%);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .xero-banner-inner {
        max-width: 80rem;
        margin: 0 auto;
        padding: 12px 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
    }

    .xero-banner-left {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 0;
        flex: 1;
    }

    .xero-logo {
        width: 24px;
        height: 24px;
        flex-shrink: 0;
        background: white;
        border-radius: 4px;
        padding: 4px;
    }

    .xero-status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .xero-status-dot--healthy { background: #22c55e; }
    .xero-status-dot--expiring { background: #fbbf24; animation: pulse-warning 2s infinite; }
    .xero-status-dot--expired { background: #ef4444; }
    .xero-status-dot--disconnected { background: #9ca3af; }

    @keyframes pulse-warning {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .xero-banner-text {
        flex: 1;
        min-width: 0;
    }

    .xero-banner-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: white;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .xero-banner-message {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.9);
        margin-top: 2px;
    }

    .xero-banner-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
    }

    .xero-btn {
        font-size: 0.8125rem;
        font-weight: 500;
        padding: 6px 16px;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.15);
        color: white;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.15s;
        text-decoration: none;
        display: inline-block;
        backdrop-filter: blur(10px);
    }

    .xero-btn:hover {
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-1px);
    }

    .xero-btn--solid {
        background: white;
        color: #13B5EA;
        border-color: white;
    }

    .xero-btn--solid:hover {
        background: #f8fafc;
        color: #0E8FC2;
    }

    .xero-btn--danger {
        background: rgba(239, 68, 68, 0.15);
        border-color: rgba(239, 68, 68, 0.3);
    }

    .xero-btn--danger:hover {
        background: rgba(239, 68, 68, 0.25);
        border-color: rgba(239, 68, 68, 0.5);
    }

    /* Org dropdown */
    .xero-org-wrap {
        position: relative;
    }

    .xero-org-dropdown {
        display: none;
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        min-width: 260px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        z-index: 50;
        overflow: hidden;
    }

    .xero-org-dropdown.open {
        display: block;
        animation: dropdown-appear 0.2s ease-out;
    }

    @keyframes dropdown-appear {
        from {
            opacity: 0;
            transform: translateY(-8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .xero-org-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 16px;
        font-size: 0.875rem;
        color: #374151;
        cursor: pointer;
        transition: background 0.1s;
    }

    .xero-org-item:hover {
        background: #f3f4f6;
    }

    .xero-org-item--active {
        font-weight: 600;
        color: #13B5EA;
        background: #f0f9ff;
    }

    .xero-org-check {
        width: 16px;
        text-align: center;
        flex-shrink: 0;
        color: #13B5EA;
    }

    .xero-org-divider {
        border-top: 1px solid #e5e7eb;
        margin: 4px 0;
    }

    .xero-org-connect {
        color: #13B5EA;
        font-weight: 500;
    }

    @media (max-width: 768px) {
        .xero-banner-inner {
            flex-wrap: wrap;
            padding: 10px 1rem;
        }
        .xero-banner-message {
            display: none;
        }
        .xero-btn {
            font-size: 0.75rem;
            padding: 5px 12px;
        }
    }
</style>

<div id="xero-connection-banner" class="xero-connection-banner hidden">
    <div class="xero-banner-inner">
        <div class="xero-banner-left">
            <!-- Xero Logo Icon -->
            <svg class="xero-logo" viewBox="0 0 24 24" fill="#13B5EA">
                <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
            </svg>

            <span class="xero-status-dot xero-status-dot--disconnected" id="xero-status-dot"></span>

            <div class="xero-banner-text">
                <div class="xero-banner-label" id="xero-banner-label">Not connected to Xero</div>
                <div class="xero-banner-message" id="xero-banner-message"></div>
            </div>
        </div>

        <div class="xero-banner-actions">
            <!-- Switch Org Dropdown -->
            <div class="xero-org-wrap" id="xero-org-wrap" style="display:none;">
                <button class="xero-btn" id="xero-org-toggle">
                    Switch org &#9662;
                </button>
                <div class="xero-org-dropdown" id="xero-org-dropdown"></div>
            </div>

            <!-- Single Connection Button (Connect/Reconnect/Disconnect) -->
            <a href="/xero/login" class="xero-btn xero-btn--solid" id="xero-connection-btn" style="display:none;">
                Connect
            </a>
        </div>
    </div>
</div>

<script>
(function() {
    var banner = document.getElementById('xero-connection-banner');
    var statusDot = document.getElementById('xero-status-dot');
    var label = document.getElementById('xero-banner-label');
    var message = document.getElementById('xero-banner-message');
    var connectionBtn = document.getElementById('xero-connection-btn');
    var orgWrap = document.getElementById('xero-org-wrap');
    var orgToggle = document.getElementById('xero-org-toggle');
    var orgDropdown = document.getElementById('xero-org-dropdown');

    function setStatusDot(status) {
        statusDot.className = 'xero-status-dot xero-status-dot--' + status;
    }

    function renderStatus(data) {
        banner.classList.remove('hidden');
        setStatusDot(data.status);

        // Update label
        if (data.connected && data.tenant_name) {
            label.textContent = 'Connected to: ' + data.tenant_name;
        } else if (data.status === 'expired') {
            label.textContent = data.tenant_name ? 'Expired: ' + data.tenant_name : 'Xero connection expired';
        } else {
            label.textContent = 'Not connected to Xero';
        }

        // Update message
        message.textContent = '';
        if (data.status === 'expired') {
            message.textContent = 'Token expired — reconnect to avoid interruptions';
        } else if (data.status === 'expiring') {
            message.textContent = 'Connection expiring soon — reconnect to avoid interruptions';
        }

        // Update connection button based on status
        connectionBtn.style.display = '';
        orgWrap.style.display = 'none';

        if (data.status === 'disconnected') {
            // Show Connect button
            connectionBtn.textContent = 'Connect';
            connectionBtn.href = '/xero/login';
            connectionBtn.className = 'xero-btn xero-btn--solid';
        } else if (data.status === 'expired' || data.status === 'expiring') {
            // Show Reconnect button
            connectionBtn.textContent = 'Reconnect';
            connectionBtn.href = '/xero/login';
            connectionBtn.className = 'xero-btn xero-btn--solid';
            orgWrap.style.display = '';
        } else {
            // Show Disconnect button
            connectionBtn.textContent = 'Disconnect';
            connectionBtn.href = '/xero/disconnect';
            connectionBtn.className = 'xero-btn xero-btn--danger';
            connectionBtn.onclick = function(e) {
                e.preventDefault();
                if (confirm('Are you sure you want to disconnect from Xero?')) {
                    fetch('/xero/disconnect', {
                        method: 'POST',
                        credentials: 'same-origin'
                    })
                    .then(function() { window.location.reload(); })
                    .catch(function() {});
                }
            };
            orgWrap.style.display = '';
        }
    }

    function fetchStatus() {
        fetch('/api/connection-status', { credentials: 'same-origin' })
            .then(function(r) { return r.json(); })
            .then(renderStatus)
            .catch(function() {});
    }

    function fetchOrgs() {
        fetch('/xero/api/connections', { credentials: 'same-origin' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var list = data.connections || [];
                var html = '';
                list.forEach(function(c) {
                    var activeClass = c.is_active ? ' xero-org-item--active' : '';
                    var check = c.is_active ? '&#10003;' : '';
                    html += '<div class="xero-org-item' + activeClass + '" data-tid="' +
                        c.tenant_id + '">' +
                        '<span class="xero-org-check">' + check + '</span>' +
                        '<span>' + escapeHtml(c.tenant_name) + '</span></div>';
                });
                html += '<div class="xero-org-divider"></div>';
                html += '<a href="/xero/login" class="xero-org-item xero-org-connect" style="text-decoration:none;">' +
                    '<span class="xero-org-check">+</span><span>Connect another org</span></a>';
                orgDropdown.innerHTML = html;

                // Bind click on org items
                orgDropdown.querySelectorAll('[data-tid]').forEach(function(el) {
                    el.addEventListener('click', function() {
                        var tid = this.getAttribute('data-tid');
                        switchOrg(tid);
                    });
                });
            })
            .catch(function() {});
    }

    function switchOrg(tenantId) {
        fetch('/xero/api/switch-connection', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tenant_id: tenantId })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                window.location.reload();
            }
        })
        .catch(function() {});
    }

    function escapeHtml(str) {
        var d = document.createElement('div');
        d.appendChild(document.createTextNode(str || ''));
        return d.innerHTML;
    }

    // Toggle org dropdown
    orgToggle.addEventListener('click', function(e) {
        e.stopPropagation();
        orgDropdown.classList.toggle('open');
        if (orgDropdown.classList.contains('open')) {
            fetchOrgs();
        }
    });

    // Close dropdown on outside click
    document.addEventListener('click', function(e) {
        if (!orgDropdown.contains(e.target) && e.target !== orgToggle) {
            orgDropdown.classList.remove('open');
        }
    });

    // Initial fetch and polling
    fetchStatus();
    setInterval(fetchStatus, 120000); // 2 minutes
})();
</script>
{% endif %}
