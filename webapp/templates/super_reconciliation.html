{% extends "base.html" %}

{% block title %}Super Guarantee Reconciliation - BAS Reviewer{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Super Guarantee Reconciliation</h1>
                <p class="mt-1 text-gray-500">Check payroll SG liability against actual super payments</p>
            </div>
        </div>
    </div>
</section>

<!-- Controls Bar -->
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
        <div class="flex flex-wrap gap-4 items-end">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Quarter</label>
                <select id="quarterSelect" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-primary focus:border-primary">
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Xero Access Token</label>
                <input type="password" id="accessToken" placeholder="Paste token"
                       class="border border-gray-300 rounded-lg px-3 py-2 text-sm w-64 focus:ring-primary focus:border-primary">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tenant ID</label>
                <input type="text" id="tenantId" placeholder="Xero tenant ID"
                       class="border border-gray-300 rounded-lg px-3 py-2 text-sm w-64 focus:ring-primary focus:border-primary">
            </div>
            <button onclick="generateReport()" id="generateBtn"
                    class="bg-primary hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-sm font-medium transition-colors">
                Generate Report
            </button>
        </div>
    </div>
</section>

<!-- Summary Cards -->
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" id="summarySection" style="display:none;">
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
            <p class="text-xs font-medium text-gray-500 uppercase">Total Liability</p>
            <p class="text-xl font-bold text-gray-900 mt-1" id="cardLiability">$0.00</p>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
            <p class="text-xs font-medium text-gray-500 uppercase">Total Paid</p>
            <p class="text-xl font-bold text-gray-900 mt-1" id="cardPaid">$0.00</p>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
            <p class="text-xs font-medium text-gray-500 uppercase">Variance</p>
            <p class="text-xl font-bold text-gray-900 mt-1" id="cardVariance">$0.00</p>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
            <p class="text-xs font-medium text-gray-500 uppercase">SG Deadline</p>
            <p class="text-xl font-bold text-gray-900 mt-1" id="cardDeadline">-</p>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
            <p class="text-xs font-medium text-gray-500 uppercase">SG Rate</p>
            <p class="text-xl font-bold text-gray-900 mt-1" id="cardRate">-</p>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200" id="statusCard">
            <p class="text-xs font-medium text-gray-500 uppercase">Status</p>
            <p class="text-xl font-bold mt-1" id="cardStatus">-</p>
        </div>
    </div>

    <!-- Status Message -->
    <div id="statusMessage" class="mb-6 p-4 rounded-lg border" style="display:none;">
        <p id="statusText" class="text-sm"></p>
    </div>
</section>

<!-- Employee Breakdown -->
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-6" id="employeeSection" style="display:none;">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
        <button onclick="toggleSection('employeeTable')" class="w-full p-6 text-left flex items-center justify-between border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Employee Breakdown</h2>
            <svg class="w-5 h-5 text-gray-400 transform transition-transform" id="employeeChevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </button>
        <div id="employeeTable" class="p-6">
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-3 px-2 font-medium text-gray-600">Employee</th>
                            <th class="text-right py-3 px-2 font-medium text-gray-600">Gross Earnings</th>
                            <th class="text-right py-3 px-2 font-medium text-gray-600">SG Rate</th>
                            <th class="text-right py-3 px-2 font-medium text-gray-600">Expected Super</th>
                            <th class="text-right py-3 px-2 font-medium text-gray-600">Payslip Super</th>
                        </tr>
                    </thead>
                    <tbody id="employeeBody">
                    </tbody>
                    <tfoot id="employeeFoot">
                    </tfoot>
                </table>
            </div>
            <p id="noPayrollMsg" class="text-gray-500 text-sm py-4" style="display:none;">
                No payroll access or no pay runs found for this period.
            </p>
        </div>
    </div>
</section>

<!-- Payments Table -->
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-6" id="paymentsSection" style="display:none;">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Super Payments</h2>
        </div>
        <div class="p-6">
            <div class="overflow-x-auto">
                <table class="w-full text-sm" id="paymentsTable">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-3 px-2 font-medium text-gray-600">Date</th>
                            <th class="text-left py-3 px-2 font-medium text-gray-600">Description</th>
                            <th class="text-left py-3 px-2 font-medium text-gray-600">Account</th>
                            <th class="text-right py-3 px-2 font-medium text-gray-600">Amount</th>
                            <th class="text-center py-3 px-2 font-medium text-gray-600">Status</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsBody">
                    </tbody>
                </table>
            </div>
            <p id="noPaymentsMsg" class="text-gray-500 text-sm py-4" style="display:none;">
                No super payments found for this period.
            </p>
        </div>
    </div>
</section>

<!-- Email Reminder -->
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-6" id="reminderSection" style="display:none;">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Send Reminder Email</h2>
            <p class="text-sm text-gray-500 mt-1">Send a super guarantee reminder to the client</p>
        </div>
        <div class="p-6">
            <div class="flex flex-wrap gap-4 items-end">
                <div class="flex-1 min-w-[250px]">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Client Email</label>
                    <input type="email" id="clientEmail" placeholder="client@example.com"
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-primary focus:border-primary">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Organisation Name</label>
                    <input type="text" id="tenantName" placeholder="Company Pty Ltd"
                           class="border border-gray-300 rounded-lg px-3 py-2 text-sm w-48 focus:ring-primary focus:border-primary">
                </div>
                <label class="flex items-center gap-2 pb-2">
                    <input type="checkbox" id="saveDefaultEmail" class="rounded border-gray-300 text-primary focus:ring-primary">
                    <span class="text-sm text-gray-600">Save as default</span>
                </label>
                <button onclick="sendReminder()" id="sendReminderBtn"
                        class="bg-yellow-500 hover:bg-yellow-600 text-white px-5 py-2 rounded-lg text-sm font-medium transition-colors">
                    Send Reminder
                </button>
            </div>
            <div id="reminderResult" class="mt-3" style="display:none;"></div>
        </div>
    </div>
</section>

<!-- Download Bar -->
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12" id="downloadSection" style="display:none;">
    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 flex items-center justify-between">
        <p class="text-sm text-gray-600">Download the full reconciliation report</p>
        <button onclick="downloadCSV()" class="border border-gray-300 text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
            Download CSV
        </button>
    </div>
</section>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black/20 flex items-center justify-center z-50" style="display:none;">
    <div class="bg-white rounded-xl p-8 shadow-lg text-center">
        <div class="animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full mx-auto mb-4"></div>
        <p class="text-gray-600 text-sm">Fetching data from Xero...</p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// State
let currentResult = null;

function formatCurrency(amount) {
    const formatted = Math.abs(amount).toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    return amount < 0 ? '-$' + formatted : '$' + formatted;
}

// Populate quarter selector
function populateQuarters() {
    const select = document.getElementById('quarterSelect');
    const now = new Date();
    const year = now.getFullYear();

    const quarters = [
        {label: `Q1 Jul-Sep ${year}`, from: `${year}-07-01`, to: `${year}-09-30`},
        {label: `Q2 Oct-Dec ${year}`, from: `${year}-10-01`, to: `${year}-12-31`},
        {label: `Q3 Jan-Mar ${year}`, from: `${year}-01-01`, to: `${year}-03-31`},
        {label: `Q4 Apr-Jun ${year}`, from: `${year}-04-01`, to: `${year}-06-30`},
        {label: `Q1 Jul-Sep ${year-1}`, from: `${year-1}-07-01`, to: `${year-1}-09-30`},
        {label: `Q2 Oct-Dec ${year-1}`, from: `${year-1}-10-01`, to: `${year-1}-12-31`},
        {label: `Q3 Jan-Mar ${year-1}`, from: `${year-1}-01-01`, to: `${year-1}-03-31`},
        {label: `Q4 Apr-Jun ${year-1}`, from: `${year-1}-04-01`, to: `${year-1}-06-30`},
    ];

    // Auto-select current quarter
    const month = now.getMonth() + 1;
    let defaultIdx = 0;
    if (month >= 7 && month <= 9) defaultIdx = 0;
    else if (month >= 10 && month <= 12) defaultIdx = 1;
    else if (month >= 1 && month <= 3) defaultIdx = 2;
    else defaultIdx = 3;

    quarters.forEach((q, i) => {
        const opt = document.createElement('option');
        opt.value = `${q.from}|${q.to}`;
        opt.textContent = q.label;
        if (i === defaultIdx) opt.selected = true;
        select.appendChild(opt);
    });
}

function toggleSection(id) {
    const el = document.getElementById(id);
    const chevron = document.getElementById(id.replace('Table', 'Chevron'));
    if (el.style.display === 'none') {
        el.style.display = '';
        if (chevron) chevron.style.transform = 'rotate(180deg)';
    } else {
        el.style.display = 'none';
        if (chevron) chevron.style.transform = '';
    }
}

async function generateReport() {
    const btn = document.getElementById('generateBtn');
    const overlay = document.getElementById('loadingOverlay');
    const quarterVal = document.getElementById('quarterSelect').value;
    const accessToken = document.getElementById('accessToken').value.trim();
    const tenantId = document.getElementById('tenantId').value.trim();

    if (!accessToken || !tenantId) {
        alert('Please enter your Xero access token and tenant ID.');
        return;
    }

    const [fromDate, toDate] = quarterVal.split('|');

    btn.disabled = true;
    btn.textContent = 'Generating...';
    overlay.style.display = 'flex';

    try {
        const params = new URLSearchParams({
            from_date: fromDate,
            to_date: toDate,
            access_token: accessToken,
            tenant_id: tenantId,
        });

        const response = await fetch(`/super-reconciliation/api/generate?${params}`);
        const data = await response.json();

        if (!response.ok || !data.success) {
            alert(data.error || 'Failed to generate reconciliation');
            return;
        }

        currentResult = data;
        renderResults(data);

    } catch (err) {
        alert('Network error. Please try again.');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Generate Report';
        overlay.style.display = 'none';
    }
}

function renderResults(data) {
    const summary = data.summary;
    const sgInfo = data.sg_info;

    // Show sections
    document.getElementById('summarySection').style.display = '';
    document.getElementById('employeeSection').style.display = '';
    document.getElementById('paymentsSection').style.display = '';
    document.getElementById('downloadSection').style.display = '';

    // Summary cards
    document.getElementById('cardLiability').textContent = formatCurrency(summary.total_liability);
    document.getElementById('cardPaid').textContent = formatCurrency(summary.total_paid);

    const varianceEl = document.getElementById('cardVariance');
    varianceEl.textContent = formatCurrency(summary.variance);
    varianceEl.className = 'text-xl font-bold mt-1 ' + (summary.variance > 0 ? 'text-red-600' : 'text-green-600');

    document.getElementById('cardDeadline').textContent = sgInfo.deadline_display;
    document.getElementById('cardRate').textContent = sgInfo.sg_rate_display;

    const statusEl = document.getElementById('cardStatus');
    statusEl.textContent = summary.status_label;
    const colorMap = {green: 'text-green-600', yellow: 'text-yellow-600', red: 'text-red-600'};
    statusEl.className = 'text-xl font-bold mt-1 ' + (colorMap[summary.status_color] || 'text-gray-900');

    const statusCard = document.getElementById('statusCard');
    const borderMap = {green: 'border-green-300', yellow: 'border-yellow-300', red: 'border-red-300'};
    statusCard.className = 'bg-white rounded-xl p-4 shadow-sm border-2 ' + (borderMap[summary.status_color] || 'border-gray-200');

    // Status message
    const msgEl = document.getElementById('statusMessage');
    const msgText = document.getElementById('statusText');
    msgText.textContent = summary.message;
    const msgColors = {
        green: 'bg-green-50 border-green-200 text-green-800',
        yellow: 'bg-yellow-50 border-yellow-200 text-yellow-800',
        red: 'bg-red-50 border-red-200 text-red-800',
    };
    msgEl.className = 'mb-6 p-4 rounded-lg border ' + (msgColors[summary.status_color] || 'bg-gray-50 border-gray-200');
    msgEl.style.display = '';

    // Employee table
    const empBody = document.getElementById('employeeBody');
    const empFoot = document.getElementById('employeeFoot');
    const noPayroll = document.getElementById('noPayrollMsg');

    empBody.innerHTML = '';
    empFoot.innerHTML = '';

    if (!summary.has_payroll || data.employees.length === 0) {
        noPayroll.style.display = '';
        document.getElementById('paymentsTable').parentElement.parentElement.querySelector('table').style.display = 'none';
    } else {
        noPayroll.style.display = 'none';
        let totalGross = 0, totalExpected = 0, totalPayslip = 0;

        data.employees.forEach(emp => {
            totalGross += emp.gross_earnings;
            totalExpected += emp.expected_super;
            totalPayslip += emp.payslip_super;

            empBody.innerHTML += `
                <tr class="border-b border-gray-100">
                    <td class="py-2 px-2 text-gray-900">${escapeHtml(emp.name)}</td>
                    <td class="py-2 px-2 text-right text-gray-700">${formatCurrency(emp.gross_earnings)}</td>
                    <td class="py-2 px-2 text-right text-gray-700">${(emp.sg_rate * 100).toFixed(1)}%</td>
                    <td class="py-2 px-2 text-right text-gray-700">${formatCurrency(emp.expected_super)}</td>
                    <td class="py-2 px-2 text-right text-gray-700">${formatCurrency(emp.payslip_super)}</td>
                </tr>
            `;
        });

        empFoot.innerHTML = `
            <tr class="border-t-2 border-gray-300 font-semibold">
                <td class="py-3 px-2 text-gray-900">Total</td>
                <td class="py-3 px-2 text-right text-gray-900">${formatCurrency(totalGross)}</td>
                <td class="py-3 px-2 text-right text-gray-900">-</td>
                <td class="py-3 px-2 text-right text-gray-900">${formatCurrency(totalExpected)}</td>
                <td class="py-3 px-2 text-right text-gray-900">${formatCurrency(totalPayslip)}</td>
            </tr>
        `;
    }

    // Payments table
    const payBody = document.getElementById('paymentsBody');
    const noPayments = document.getElementById('noPaymentsMsg');
    payBody.innerHTML = '';

    if (data.payments.length === 0) {
        noPayments.style.display = '';
    } else {
        noPayments.style.display = 'none';
        data.payments.forEach(pay => {
            const lateClass = pay.is_late ? 'bg-red-50' : '';
            const statusBadge = pay.is_late
                ? '<span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full font-medium">LATE</span>'
                : '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-medium">On Time</span>';

            payBody.innerHTML += `
                <tr class="border-b border-gray-100 ${lateClass}">
                    <td class="py-2 px-2 text-gray-700">${escapeHtml(pay.date_display)}</td>
                    <td class="py-2 px-2 text-gray-700">${escapeHtml(pay.description)}</td>
                    <td class="py-2 px-2 text-gray-700">${escapeHtml(pay.account_name)}</td>
                    <td class="py-2 px-2 text-right text-gray-700">${formatCurrency(pay.amount)}</td>
                    <td class="py-2 px-2 text-center">${statusBadge}</td>
                </tr>
            `;
        });
    }

    // Show reminder section if status is not pass
    if (summary.status !== 'pass') {
        document.getElementById('reminderSection').style.display = '';
        loadDefaultEmail();
    } else {
        document.getElementById('reminderSection').style.display = 'none';
    }
}

function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

async function loadDefaultEmail() {
    try {
        const res = await fetch('/super-reconciliation/api/client-email');
        const data = await res.json();
        if (data.success && data.email) {
            document.getElementById('clientEmail').value = data.email;
        }
    } catch (e) {
        // Silently fail
    }
}

async function sendReminder() {
    if (!currentResult || !currentResult.summary) {
        alert('Generate a report first.');
        return;
    }

    const email = document.getElementById('clientEmail').value.trim();
    const tenantName = document.getElementById('tenantName').value.trim();
    const saveDefault = document.getElementById('saveDefaultEmail').checked;

    if (!email) {
        alert('Please enter a client email address.');
        return;
    }
    if (!tenantName) {
        alert('Please enter the organisation name.');
        return;
    }

    const btn = document.getElementById('sendReminderBtn');
    btn.disabled = true;
    btn.textContent = 'Sending...';

    try {
        // Save default email if checked
        if (saveDefault) {
            await fetch('/super-reconciliation/api/client-email', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email: email}),
            });
        }

        const response = await fetch('/super-reconciliation/api/send-reminder', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                email: email,
                quarter_label: currentResult.sg_info.label,
                deadline: currentResult.sg_info.deadline_display,
                total_liability: currentResult.summary.total_liability,
                total_paid: currentResult.summary.total_paid,
                variance: currentResult.summary.variance,
                status: currentResult.summary.status,
                tenant_name: tenantName,
            }),
        });

        const data = await response.json();
        const resultEl = document.getElementById('reminderResult');
        resultEl.style.display = '';

        if (data.success && data.email_sent) {
            resultEl.innerHTML = '<p class="text-sm text-green-700 bg-green-50 rounded-lg p-3">Reminder email sent successfully.</p>';
        } else {
            resultEl.innerHTML = `<p class="text-sm text-red-700 bg-red-50 rounded-lg p-3">${escapeHtml(data.error || 'Failed to send email')}</p>`;
        }

    } catch (err) {
        alert('Network error sending reminder.');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Send Reminder';
    }
}

function downloadCSV() {
    if (!currentResult) return;

    const quarterVal = document.getElementById('quarterSelect').value;
    const [fromDate, toDate] = quarterVal.split('|');
    const accessToken = document.getElementById('accessToken').value.trim();
    const tenantId = document.getElementById('tenantId').value.trim();

    const params = new URLSearchParams({
        from_date: fromDate,
        to_date: toDate,
        access_token: accessToken,
        tenant_id: tenantId,
    });

    window.location.href = `/super-reconciliation/api/download?${params}`;
}

// Init
populateQuarters();
</script>
{% endblock %}
